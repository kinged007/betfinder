{% extends "base.html" %}

{% block content %}
<script src="{{ url_for('static', path='js/stake_calculator.js') }}"></script>
<script src="{{ url_for('static', path='js/bet_modal.js') }}"></script>

<style>
    /* Flash animations for odds changes */
    @keyframes flashGreen {
        0% {
            background-color: rgba(34, 197, 94, 0.4);
        }

        100% {
            background-color: transparent;
        }
    }

    @keyframes flashRed {
        0% {
            background-color: rgba(239, 68, 68, 0.4);
        }

        100% {
            background-color: transparent;
        }
    }

    .flash-increase {
        animation: flashGreen 1.5s ease-out;
    }

    .flash-decrease {
        animation: flashRed 1.5s ease-out;
    }

    .pulse-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-connected {
        background-color: #22c55e;
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        animation: pulse-green 2s infinite;
    }

    .status-disconnected {
        background-color: #ef4444;
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }

    @keyframes pulse-green {
        0% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }

        70% {
            transform: scale(1);
            box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }

        100% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
    }
</style>
<div class="w-full md:max-w-6xl px-0 md:px-4">
    {% if current_preset %}
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 px-4 md:px-0">
        <div class="flex items-center gap-3">
            <div id="ws-indicator" class="pulse-dot status-disconnected tooltip tooltip-right cursor-help"
                data-tip="Connecting..."></div>
            <h2 class="text-xl md:text-2xl font-bold">{{ current_preset.name }}</h2>
            <a href="/presets-view?edit_id={{ current_preset.id }}" class="btn btn-ghost btn-xs btn-circle tooltip"
                data-tip="Edit Preset">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            </a>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs opacity-50 uppercase font-bold">Group By:</span>
            <div class="join shadow-sm border border-base-300">
                <button class="btn btn-sm join-item bg-base-200 active-group"
                    onclick="setGroupBy('none', this)">None</button>
                <button class="btn btn-sm join-item bg-base-200" onclick="setGroupBy('sport', this)">Sport</button>
                <button class="btn btn-sm join-item bg-base-200" onclick="setGroupBy('bookmaker', this)">Bookie</button>
                <button class="btn btn-sm join-item bg-base-200" onclick="setGroupBy('league', this)">League</button>
                <button class="btn btn-sm join-item bg-base-200" onclick="setGroupBy('event', this)">Event</button>
                <button class="btn btn-sm btn-ghost gap-2 border border-base-300 shadow-sm" onclick="openHiddenModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="card bg-base-100 shadow-xl md:rounded-xl rounded-none">
        <div class="card-body p-0 md:p-1 overflow-visible">
            <table class="table w-full" id="trade-table">
                <thead>
                    <tr class="bg-base-200 text-[10px] md:text-sm">
                        <th class="cursor-pointer hover:bg-base-300 transition-colors px-2 md:px-4"
                            onclick="setSort('start_time')">
                            <div class="flex items-center gap-1">Time <span id="sort-start_time"></span></div>
                        </th>
                        <th class="cursor-pointer hover:bg-base-300 transition-colors px-2 md:px-4"
                            onclick="setSort('home')">
                            <div class="flex items-center gap-1">Market <span id="sort-home"></span></div>
                        </th>

                        <th class="px-1 cursor-pointer hover:bg-base-300 transition-colors" onclick="setSort('price')">
                            <div class="flex items-center gap-1 justify-center text-center">Odds <span
                                    id="sort-price"></span>
                            </div>
                        </th>

                        <th class="px-1 cursor-pointer hover:bg-base-300 transition-colors" onclick="setSort('edge')">
                            <div class="flex items-center gap-1 justify-center text-center">Edge <span
                                    id="sort-edge"></span>
                            </div>
                        </th>
                        <th class="px-1 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="trade-feed-body">
                    <tr>
                        <td colspan="5" class="text-center py-10">
                            <span class="loading loading-spinner loading-lg"></span>
                            <div class="mt-2 text-gray-500">Waiting for data...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    {% include 'components/bet_modal.html' %}

    <style>
        .active-group {
            background-color: var(--primary) !important;
            color: var(--primary-content) !important;
        }

        .group-header {
            background-color: var(--fallback-b3, oklch(var(--b3)));
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }



        .sort-icon {
            font-size: 10px;
            opacity: 0.5;
        }

        /* Paired row hover effect - strictly constrained to the trade item block */
        .trade-row-1:hover,
        .trade-row-1:hover+.trade-row-2,
        .trade-row-2:hover,
        .trade-row-1:has(+ .trade-row-2:hover) {
            background-color: rgba(255, 255, 255, 0.07) !important;
        }


        @media (max-width: 768px) {
            .hidden-items-table {
                font-size: 0.7rem;
            }

            .hidden-items-table .btn {
                font-size: 0.6rem;
                padding-left: 0.25rem;
                padding-right: 0.25rem;
                height: 1.25rem;
                min-height: 1.25rem;
            }
        }
    </style>

    <!-- Hidden Items Modal -->
    <dialog id="hidden-items-modal" class="modal">
        <div class="modal-box w-11/12 max-w-6xl p-0 h-[95vh] md:h-auto max-h-[95vh] md:max-h-[85vh] flex flex-col">
            <div class="p-6 border-b border-base-300 flex justify-between items-center sticky top-0 bg-base-100 z-10">
                <h3 class="font-bold text-lg">Hidden Opportunities</h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost">✕</button>
                </form>
            </div>
            <div class="p-0 overflow-y-auto overflow-x-visible flex-grow">
                <table class="table table-zebra w-full hidden-items-table">
                    <thead class="bg-base-200 sticky top-0 z-10">
                        <tr>
                            <th class="hidden md:table-cell">Start Time</th>
                            <th>Event & Market</th>
                            <th class="hidden lg:table-cell">Bookie</th>
                            <th>Odds</th>
                            <th>Edge</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="hidden-items-body">
                        <!-- Content loaded via JS -->
                    </tbody>
                </table>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        const presetId = "{{ current_preset.id }}";
        window.currentPresetId = presetId;
        window.currentPresetDefaultStake = "{{ current_preset.default_stake or 10 }}";
        window.currentPresetAfterTradeAction = "{{ current_preset.after_trade_action or 'none' }}";
        
        // Staking strategy configuration
        window.currentPresetStakingStrategy = "{{ current_preset.staking_strategy or 'fixed' }}";
        window.currentPresetPercentRisk = {{ current_preset.percent_risk or 'null' }};
        window.currentPresetKellyMultiplier = {{ current_preset.kelly_multiplier or 'null' }};
        window.currentPresetMaxStake = {{ current_preset.max_stake or 'null' }};

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/tradefeed/${presetId}`);
        const tbody = document.getElementById("trade-feed-body");
        const indicator = document.getElementById('ws-indicator');
        window.lastData = []; // Expose globally for bet_modal.js
        window.renderData = renderData; // Expose globally

        // Config from preset
        const otherConfig = {{ (current_preset.other_config or { }) | tojson | safe }};
        let currentGroupBy = otherConfig.group_by || 'none';
        let sortCol = otherConfig.sort_by || 'edge';
        let sortDir = otherConfig.sort_order || 'desc';
        let collapsedGroups = new Set();



        // Set initial group active button
        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.join-item').forEach(btn => {
                const mode = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (mode === currentGroupBy) {
                    document.querySelectorAll('.join-item').forEach(b => b.classList.remove('active-group'));
                    btn.classList.add('active-group');
                }
            });
            updateSortUI();
        });

        function toggleGroup(key) {
            if (collapsedGroups.has(key)) {
                collapsedGroups.delete(key);
            } else {
                collapsedGroups.add(key);
            }
            renderData(lastData);
        }

        function setGroupBy(mode, btn) {
            if (currentGroupBy !== mode) {
                collapsedGroups.clear();
            }
            currentGroupBy = mode;
            document.querySelectorAll('.join-item').forEach(b => b.classList.remove('active-group'));
            btn.classList.add('active-group');
            renderData(lastData);
        }

        function setSort(col) {
            if (sortCol === col) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortCol = col;
                sortDir = 'asc';
            }
            updateSortUI();
            renderData(lastData);
        }

        function updateSortUI() {
            // Reset all icons
            ['start_time', 'home', 'bookmaker', 'price', 'true_odds', 'edge'].forEach(c => {
                const el = document.getElementById(`sort-${c}`);
                if (el) el.innerHTML = '';
            });

            const activeEl = document.getElementById(`sort-${sortCol}`);
            if (activeEl) {
                activeEl.innerHTML = sortDir === 'asc' ? '▲' : '▼';
                activeEl.className = 'sort-icon opacity-100 text-primary';
            }
        }

        function renderData(data) {
            let html = "";

            if (data.length === 0) {
                html = `<tr><td colspan="5" class="text-center py-10" id="no-data-msg">
                            <span class="loading loading-spinner loading-lg"></span>
                            <div class="mt-2 text-gray-500">Waiting for data or no opportunities found...</div>
                        </td></tr>`;

                // If the table is currently empty or showing waiting message, just set it
                if (tbody.children.length === 0 || tbody.querySelector('#no-data-msg')) {
                    tbody.innerHTML = html;
                } else {
                    Alpine.morph(tbody, html);
                }
                return;
            }

            // Apply sorting
            const sortedData = [...data].sort((a, b) => {
                let valA = a[sortCol];
                let valB = b[sortCol];

                // Handle case-insensitive string compare
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });

            if (currentGroupBy === 'none') {
                html = sortedData.map((item, idx) => getRowHtml(item, idx % 2 === 0)).join('');
            } else {
                const groups = {};
                const groupOrder = [];
                sortedData.forEach(item => {
                    let key = "";
                    if (currentGroupBy === 'sport') key = item.sport;
                    else if (currentGroupBy === 'league') key = item.league;
                    else if (currentGroupBy === 'bookmaker') key = item.bookmaker;
                    else if (currentGroupBy === 'event') key = `${item.home} vs ${item.away}`;

                    if (!groups[key]) {
                        groups[key] = [];
                        groupOrder.push(key);
                    }
                    groups[key].push(item);
                });

                let globalTradeIdx = 0;
                groupOrder.forEach(key => {
                    const groupRows = groups[key];
                    const isCollapsed = collapsedGroups.has(key);

                    // Create a sanitized key for the onclick handler
                    const escapedKey = key.replace(/'/g, "\\'");

                    html += `
                        <tr class="group-header cursor-pointer select-none transition-colors hover:bg-base-200" 
                            onclick="toggleGroup('${escapedKey}')">
                            <td colspan="5" class="py-2 px-4 shadow-sm">
                                <div class="flex items-center gap-3">
                                    <span class="text-[10px] transition-transform duration-200 ${isCollapsed ? '-rotate-90' : ''}">▼</span>
                                    <span class="text-xs font-bold tracking-widest">${key}</span>
                                    <div class="flex-grow"></div>
                                    <span class="badge badge-ghost badge-sm opacity-60 font-mono">${groupRows.length}</span>
                                </div>
                            </td>
                        </tr>
                    `;

                    if (!isCollapsed) {
                        html += groupRows.map(item => {
                            const rowHtml = getRowHtml(item, globalTradeIdx % 2 === 0);
                            globalTradeIdx++;
                            return rowHtml;
                        }).join('');
                    }
                });
            }

            // The Magic: Alpine Morph
            // We must wrap the inner HTML in the same tag/id as the target to morph OUTER html correctly
            // OR use options to morph inner. But standard is outer match.
            const newTbody = `<tbody id="trade-feed-body">${html}</tbody>`;
            Alpine.morph(tbody, newTbody);
        }

        function getRowHtml(item, isEven) {
            const edgeClass = item.edge > 0 ? "text-success" : "text-error";
            const timeHtml = window.formatLocalTime(item.start_time);
            const bgColorClass = isEven ? '' : 'bg-base-200/40';

            // Countdown logic
            let startStr = item.start_time;
            if (startStr && !startStr.endsWith('Z') && !startStr.includes('+')) {
                startStr += 'Z';
            }
            const d = new Date(startStr);
            const now = new Date();
            const diffMs = d - now;
            const diffHours = diffMs / (1000 * 60 * 60);

            let countdownLabel = "";
            if (diffHours > 0) {
                if (diffHours < 1) {
                    countdownLabel = `in ${Math.floor(diffMs / (1000 * 60))}m`;
                } else if (diffHours < 24) {
                    countdownLabel = `in ${diffHours.toFixed(0)}h`;
                } else {
                    countdownLabel = `in ${Math.floor(diffHours / 24)}d`;
                }
            } else if (diffHours > -1.5) {
                countdownLabel = `<span class="badge badge-warning badge-xs animate-pulse">LIVE</span>`;
            } else {
                countdownLabel = `<span class="badge badge-ghost badge-xs opacity-50">Completed</span>`;
            }

            const itemJson = JSON.stringify(item).replace(/"/g, '&quot;').replace(/'/g, '&#39;');

            return `
                <tr class="${bgColorClass} trade-row-1 cursor-pointer border-none" 
                    data-row-id="${item.row_id}" 
                    onclick='openBetModal(${itemJson})'>
                    <td colspan="5" class="pb-2 pt-6 border-none px-2 md:px-4">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold text-primary/70 uppercase tracking-widest">${item.sport}</span>
                            <span class="text-[10px] opacity-40">•</span>
                            <span class="text-[10px] opacity-60 font-medium">${item.league}</span>
                        </div>
                        <div class="flex items-center gap-2 overflow-hidden">
                             <div class="font-bold text-sm text-base-content/90 tracking-tight truncate">${item.home} vs ${item.away}
                             ${item.has_bet ? ' <span class="ml-2 badge badge-success badge-xs tooltip tooltip-right" data-tip="Bet Placed"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>' : ''}</div>
                             ${item.url ? `
                                <a href="${item.url}" target="_blank" class="btn btn-ghost btn-xs btn-circle p-0 h-4 w-4 min-h-0 opacity-40 hover:opacity-100" title="Open on Bookmaker" onclick="event.stopPropagation()">
                                    <svg class="w-3.5 h-3.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            ` : ''}
                        </div>
                    </td>
                </tr>
                <tr class="${bgColorClass} trade-row-2 cursor-pointer border-t-0" 
                    data-row-id="${item.row_id}" 
                    onclick='openBetModal(${itemJson})'>
                    <td class="whitespace-nowrap align-top py-2 px-2 md:px-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-3 h-3 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <div>
                                <div class="text-xs font-medium">${timeHtml}</div>
                                <div class="text-[10px] opacity-50 font-mono">${countdownLabel}</div>
                            </div>
                        </div>
                    </td>
                    <td class="align-top py-2 px-2 md:px-4">
                        <div class="flex flex-wrap gap-1 items-center">
                            <span class="text-[10px] bg-base-200 px-1 rounded font-medium uppercase truncate max-w-[80px]">${item.market}</span>
                            <span class="text-[11px] font-bold text-primary truncate max-w-[100px]">${item.selection.charAt(0).toUpperCase() + item.selection.slice(1).toLowerCase()}</span>
                            ${item.point !== null ? `<span class="text-[11px] font-bold text-secondary">(${item.point > 0 ? '+' : ''}${item.point})</span>` : ''}
                        </div>
                    </td>

                    <td class="px-1 text-center align-top py-2">
                        <div class="flex items-center justify-center gap-1">
                            <span class="font-bold text-accent text-sm">${item.price.toFixed(2)}</span>
                            ${item.implied_probability ? `<span class="text-[10px] opacity-40 whitespace-nowrap tooltip tooltip-bottom" data-tip="Implied Probability">(${(item.implied_probability * 100).toFixed(0)}%)</span>` : ''}
                        </div>
                    </td>
                    <td class="font-bold ${edgeClass} text-xs md:text-sm px-1 text-center align-top py-2">${item.edge !== null ? (item.edge * 100).toFixed(2) + '%' : '-'}</td>
                    <td class="px-1 align-top py-1" onclick="event.stopPropagation()">
                        <div class="flex flex-col items-center gap-1">
                            <div class="flex items-center gap-2">
                                <div class="dropdown dropdown-end">
                                    <label tabindex="0" class="btn btn-xs btn-ghost btn-circle" onclick="event.stopPropagation()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                                    </label>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 text-xs">
                                        <li><a onclick='hideItem("event", ${itemJson})'>Hide Event</a></li>
                                        <li><a onclick='hideItem("market", ${itemJson})'>Hide Market</a></li>
                                        <li><a onclick='hideItem("selection", ${itemJson})'>Hide Selection</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }

        async function hideItem(type, item) {
            event.stopPropagation();
            if (!confirm(`Are you sure you want to hide this ${type}?`)) return;

            // Calculate expiry: Event Start + 24 Hours
            const startTime = new Date(item.start_time);
            const expiryDate = new Date(startTime.getTime() + 24 * 60 * 60 * 1000);

            const payload = {
                event_id: item.event_id,
                expiry_at: expiryDate.toISOString()
            };

            if (type === 'market' || type === 'selection') {
                payload.market_key = item.market;
            }
            if (type === 'selection') {
                payload.selection_norm = item.selection;
            }

            try {
                const response = await fetch(`/api/v1/presets/${presetId}/hidden-items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, // Assuming dev key for now or handled by browser cookie if auth uses cookies? 
                    // Wait, presets.py uses Depends(get_api_key). If this is a wrapper for frontend `views.py` usually handles auth differently or shares session.
                    // But `router` in `presets.py` protects endpoints. The frontend JS needs the key? 
                    // Actually, usually frontend calls proxy or uses session auth if configured. 
                    // Looking at `presets.py`: `router = APIRouter(dependencies=[Depends(get_api_key)])`.
                    // The `views.py` usually renders HTML. The JS fetch needs credentials.
                    // If the user is surfing the web view, they might not have the API key in a variable. 
                    // Let's check how other API calls work or if I need to expose `api_key` in the template.
                    body: JSON.stringify(payload)
                });

                // Check auth: `app/core/security.py` check.
                // If I am using `uv run dev`, maybe auth is generic?
                // Let's assume for now I need to fetch the key or it works if I send the header.
                // Actually `views.py` usually doesn't need API key if it's session based, but `presets.py` is under `api/v1` which likely enforces API Key.
                // I might need to put the API key in the template.

                if (response.ok) {
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} hidden successfully`, 'success');
                    // Update frontend data
                    if (type === 'event') {
                        lastData = lastData.filter(d => d.event_id !== item.event_id);
                    } else if (type === 'market') {
                        lastData = lastData.filter(d => !(d.event_id === item.event_id && d.market === item.market));
                    } else {
                        lastData = lastData.filter(d => !(d.event_id === item.event_id && d.market === item.market && d.selection === item.selection));
                    }
                    renderData(lastData);
                } else {
                    console.error("Failed to hide item", await response.text());
                    showToast("Failed to hide item", "error");
                }
            } catch (e) {
                console.error(e);
                showToast("Error hiding item", "error");
            }
        }

        async function unhideItem(hidden_id) {
            if (!confirm("Un-hide this item?")) return;
            try {
                const response = await fetch(`/api/v1/presets/${presetId}/hidden-items/${hidden_id}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    showToast("Item un-hidden", "success");
                    // Refresh hidden items list
                    openHiddenModal();
                } else {
                    showToast("Failed to un-hide", "error");
                }
            } catch (e) {
                showToast("Error un-hiding", "error");
            }
        }

        async function openHiddenModal() {
            const body = document.getElementById('hidden-items-body');
            body.innerHTML = `<tr><td colspan="5" class="text-center py-20"><span class="loading loading-spinner loading-lg"></span></td></tr>`;
            document.getElementById('hidden-items-modal').showModal();

            try {
                const response = await fetch(`/trade-feed/hidden-items?preset_id=${presetId}`);
                const data = await response.json();

                if (data.length === 0) {
                    body.innerHTML = `<tr><td colspan="5" class="text-center py-20 text-gray-400">No hidden items found.</td></tr>`;
                    return;
                }

                body.innerHTML = data.map(item => {
                    const timeHtml = window.formatLocalTime(item.start_time);
                    const edgeClass = item.edge > 0 ? "text-success" : "text-error";
                    const itemJson = JSON.stringify(item).replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                    return `
                        <tr class="hover cursor-pointer hidden-item-row" onclick='openBetModal(${itemJson})'>
                            <td class="whitespace-nowrap hidden md:table-cell text-xs opacity-70 py-4">${timeHtml}</td>
                            <td class="py-4">
                                <div class="font-bold text-xs leading-tight">${item.home} vs ${item.away}</div>
                                <div class="flex flex-wrap gap-1 items-center mt-1">
                                    <span class="text-[9px] bg-base-200 px-1 rounded uppercase">${item.market}</span>
                                    <span class="text-[10px] font-bold text-primary">${item.selection}</span>
                                    ${item.point !== null ? `<span class="text-[10px] font-bold text-secondary">(${item.point > 0 ? '+' : ''}${item.point})</span>` : ''}
                                    ${item.has_bet ? ' <span class="ml-2 badge badge-success badge-xs tooltip tooltip-right" data-tip="Bet Placed"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>' : ''}
                                </div>
                            </td>
                            <td class="hidden lg:table-cell py-4"><span class="badge badge-outline badge-xs">${item.bookmaker}</span></td>
                            <td class="font-bold text-xs py-4">
                                ${item.price.toFixed(2)}
                                ${item.implied_probability ? `<div class="text-[9px] opacity-40 whitespace-nowrap tooltip tooltip-bottom" data-tip="Implied Probability">(${(item.implied_probability * 100).toFixed(0)}%)</div>` : ''}
                            </td>

                            <td class="font-bold ${edgeClass} text-xs py-4">${item.edge !== null ? (item.edge * 100).toFixed(2) + '%' : '-'}</td>
                            <td onclick="event.stopPropagation()" class="py-4">
                                 <div class="flex flex-col items-center gap-1">
                                     <button class="btn btn-xs btn-primary w-full" onclick='openBetModal(${itemJson})'>Bet</button>
                                     <button class="btn btn-xs btn-ghost text-success" onclick="unhideItem(${item.hidden_id})">Unhide</button>
                                 </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                body.innerHTML = `<tr><td colspan="5" class="text-center py-20 text-error">Failed to load hidden items.</td></tr>`;
            }
        }


        // Bet Modal Functions removed - now in static/js/bet_modal.js


        function applyFlashAnimations(oddsIncreased, oddsDecreased) {
            // Apply flash-increase class to rows with increased odds
            oddsIncreased.forEach(rowId => {
                const rows = document.querySelectorAll(`tr[data-row-id="${rowId}"]`);
                rows.forEach(row => {
                    // Reset animation
                    row.classList.remove('flash-increase');
                    row.classList.remove('flash-decrease');
                    void row.offsetWidth; // Force reflow

                    row.classList.add('flash-increase');

                    // Safety cleanup after animation ends (1.5s)
                    setTimeout(() => {
                        row.classList.remove('flash-increase');
                    }, 1500);
                });
            });

            // Apply flash-decrease class to rows with decreased odds
            oddsDecreased.forEach(rowId => {
                const rows = document.querySelectorAll(`tr[data-row-id="${rowId}"]`);
                rows.forEach(row => {
                    // Reset animation
                    row.classList.remove('flash-increase');
                    row.classList.remove('flash-decrease');
                    void row.offsetWidth; // Force reflow

                    row.classList.add('flash-decrease');

                    // Safety cleanup
                    setTimeout(() => {
                        row.classList.remove('flash-decrease');
                    }, 1500);
                });
            });
        }

        ws.onmessage = function (event) {
            const response = JSON.parse(event.data);
            const data = response.opportunities || response; // Handle both old and new format
            const oddsIncreased = response.odds_increased || [];
            const oddsDecreased = response.odds_decreased || [];

            lastData = data;
            if (typeof window.renderData === 'function') {
                window.renderData(data);
            }

            updateSortUI(); // Refresh UI indicators if data arrived while we had a sort set

            // Apply flash animations after rendering
            // Alpine Morph updates the DOM synchronously.
            if (oddsIncreased.length > 0 || oddsDecreased.length > 0) {
                applyFlashAnimations(oddsIncreased, oddsDecreased);
            }
        };

        ws.onopen = function () {
            console.log("WS Connected");
            if (indicator) {
                indicator.classList.remove('status-disconnected');
                indicator.classList.add('status-connected');
                indicator.setAttribute('data-tip', 'Live');
            }
        };

        ws.onclose = function () {
            console.log("WS Disconnected");
            const el = document.getElementById('ws-indicator');
            if (el) {
                el.classList.remove('status-connected');
                el.classList.add('status-disconnected');
                el.setAttribute('data-tip', 'Disconnected');
                // Force style update to ensure animation stops
                el.style.animation = 'none';
                el.style.backgroundColor = '#ef4444';
            }
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-error">Connection lost. Please refresh.</td></tr>`;
        };
    </script>
    {% else %}
    <div class="hero bg-base-100 rounded-box shadow-xl p-10">
        <div class="hero-content text-center">
            <div class="max-w-md">
                <h1 class="text-3xl font-bold">Select a Preset</h1>
                <p class="py-6">Choose a betting configuration preset to start scanning for opportunities.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}