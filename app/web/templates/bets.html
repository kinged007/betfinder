{% extends "base.html" %}

{% block content %}
<div class="w-full max-w-6xl mx-auto">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 px-2">
        <h2 class="text-2xl font-bold">My Bets</h2>
    </div>

    <style>
        /* Paired row hover effect */
        .bet-row-1:hover,
        .bet-row-1:hover+.bet-row-2,
        .bet-row-2:hover,
        .bet-row-1:has(+ .bet-row-2:hover) {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        .bet-row-1 td,
        .bet-row-2 td {
            border: none !important;
        }

        @media (max-width: 768px) {
            .bet-table {
                font-size: 0.75rem;
            }
        }
    </style>

    {# Macro to render the bet table #}
    {% macro render_bet_table(bets, table_id) %}
    <div class="overflow-x-hidden">
        <table class="table w-full text-sm bet-table" id="{{ table_id }}">
            <thead>
                <tr class="bg-base-200 text-[10px] md:text-sm">
                    <th class="w-full">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" class="checkbox checkbox-xs select-all-bets"
                                onchange="toggleSelectAll(this)">
                            <span class="md:hidden">Market / Bookmaker</span>
                            <span class="hidden md:inline">Market / Selection</span>
                        </div>
                    </th>
                    <th class="hidden md:table-cell text-left">Odds</th>
                    <th class="hidden md:table-cell text-left">Bookmaker</th>
                    <th class="text-right w-16 md:w-20">Stake</th>
                    <th class="text-right w-16 md:w-20">Payout</th>
                    <th class="text-right w-20 md:w-24">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for bet in bets %}
                {% set major_row_class = 'bg-base-200/40' if loop.index0 % 2 != 0 else '' %}
                <tr class="bet-row-1 group transition-colors {{ major_row_class }}" data-bet-id="{{ bet.id }}">
                    <td colspan="6" class="pb-1 pt-4 px-2 md:px-4 border-none">
                        <div class="flex items-center gap-2 mb-1">
                            <input type="checkbox" class="checkbox checkbox-xs bet-checkbox scale-90"
                                onchange="updateSelectionUI()">
                            <span class="text-[9px] font-bold text-primary/70 uppercase tracking-widest">
                                {% if bet.event %}{{ bet.event.sport_key }}{% elif bet.event_data %}{{
                                bet.event_data.sport_key }}{% endif %}
                            </span>
                            <span class="text-[9px] opacity-40">â€¢</span>
                            <span class="text-[9px] opacity-60 font-medium truncate min-w-0">
                                {% if bet.event and bet.event.league %}{{ bet.event.league.title }}{% endif %}
                            </span>

                            <!-- Time on right -->
                            <div class="ml-auto flex flex-row items-center gap-2 pr-2 shrink-0">
                                {% set commence_time = None %}
                                {% if bet.event %}{% set commence_time = bet.event.commence_time.isoformat() %}
                                {% elif bet.event_data and bet.event_data.commence_time %}{% set commence_time =
                                bet.event_data.commence_time %}{% endif %}

                                {% if commence_time %}
                                {% if 'Z' not in commence_time and '+' not in commence_time %}{% set commence_time =
                                commence_time + 'Z' %}{% endif %}
                                <div class="text-[10px] font-medium local-time" data-utc-time="{{ commence_time }}">
                                </div>
                                <div class="event-timer text-[8px]" data-start-time="{{ commence_time }}"
                                    data-bet-status="{{ bet.status }}"></div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 font-bold text-sm text-base-content/90 truncate ml-6">
                            {% if bet.event %}
                            {{ bet.event.home_team }} vs {{ bet.event.away_team }}
                            {% elif bet.event_data %}
                            {{ bet.event_data.home_team }} vs {{ bet.event_data.away_team }}
                            {% else %}
                            Unknown Event
                            {% endif %}
                            {% if bet.odd_data and bet.odd_data.url %}
                            <a href="{{ bet.odd_data.url }}" target="_blank"
                                class="btn btn-ghost btn-xs btn-circle p-0 h-4 w-4 min-h-0 opacity-40 hover:opacity-100"
                                title="Open on Bookmaker">
                                <svg class="w-3 h-3 text-blue-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                    </path>
                                </svg>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                <tr class="bet-row-2 group transition-colors border-b border-base-200 {{ major_row_class }}"
                    data-bet-id="{{ bet.id }}">
                    <!-- Mobile Only Cell -->
                    <td class="py-2 px-2 md:hidden">
                        <div class="flex flex-wrap gap-1 items-center ml-6">
                            <span
                                class="text-[9px] bg-base-200 px-1 rounded font-medium uppercase truncate max-w-[60px]">{{
                                bet.market_key }}</span>
                            <span class="text-[11px] font-bold text-primary truncate max-w-[100px]">{{
                                bet.selection|capitalize }}</span>
                            {% if bet.odd_data and bet.odd_data.point is not none %}
                            <span class="text-[11px] font-bold text-secondary">({{ '+' if bet.odd_data.point > 0 else ''
                                }}{{ bet.odd_data.point }})</span>
                            {% endif %}
                            <span class="text-[10px] font-bold text-accent ml-1">@ {{ "%.2f"|format(bet.price) }}</span>
                        </div>
                        <div class="mt-1 ml-6">
                            <span class="badge badge-outline badge-xs opacity-50 px-1">
                                {% if bet.bookmaker %}{{ bet.bookmaker.title }}{% else %}Unknown{% endif %}
                            </span>
                        </div>
                    </td>

                    <!-- Desktop: Market / Selection -->
                    <td class="hidden md:table-cell py-2 align-middle">
                        <div class="flex flex-wrap gap-1 items-center ml-6">
                            <span class="text-[9px] bg-base-200 px-1 rounded font-medium uppercase">{{ bet.market_key
                                }}</span>
                            <span class="text-[11px] font-bold text-primary">{{ bet.selection|capitalize }}</span>
                        </div>
                    </td>

                    <!-- Desktop: Odds -->
                    <td class="hidden md:table-cell py-2 align-middle">
                        <div class="flex items-center gap-1">
                            <span class="text-[11px] font-bold text-accent">@ {{ "%.2f"|format(bet.price) }}</span>
                            {% if bet.odd_data and bet.odd_data.point is not none %}
                            <span class="text-[11px] font-bold text-secondary">({{ '+' if bet.odd_data.point > 0 else ''
                                }}{{ bet.odd_data.point }})</span>
                            {% endif %}
                        </div>
                    </td>

                    <!-- Desktop: Bookmaker -->
                    <td class="hidden md:table-cell py-2 align-middle">
                        <span class="badge badge-outline badge-xs opacity-50 px-1">
                            {% if bet.bookmaker %}{{ bet.bookmaker.title }}{% else %}Unknown{% endif %}
                        </span>
                    </td>
                    <td class="text-right align-middle whitespace-nowrap">
                        <div class="font-bold text-[11px] md:text-sm">{{ "%.2f"|format(bet.stake) }}</div>
                    </td>
                    <td class="text-right align-middle whitespace-nowrap">
                        {% if bet.payout is not none %}
                        <div
                            class="font-bold text-[11px] md:text-sm {% if bet.status == 'won' %}text-success{% elif bet.status == 'lost' %}text-error{% elif bet.status == 'void' %}text-warning{% endif %}">
                            {{ "%.2f"|format(bet.payout) }}
                        </div>
                        {% else %}
                        <div class="text-[9px] md:text-xs font-bold opacity-20"
                            title="Estimate: {{ '%.2f'|format(bet.stake * bet.price) }}">
                            {{ "%.2f"|format(bet.stake * bet.price) }}
                        </div>
                        {% endif %}
                    </td>
                    <td class="align-middle">
                        <div class="flex items-center justify-end gap-1">
                            {% if bet.status == 'open' or bet.status == 'pending' %}
                            <span class="badge badge-warning badge-xs md:badge-sm capitalize">{{ bet.status }}</span>
                            {% elif bet.status == 'won' %}
                            <span class="badge badge-success badge-xs md:badge-sm capitalize">Won</span>
                            {% elif bet.status == 'lost' %}
                            <span class="badge badge-error badge-xs md:badge-sm capitalize">Lost</span>
                            {% elif bet.status == 'void' %}
                            <span class="badge badge-ghost badge-xs md:badge-sm capitalize">Void</span>
                            {% else %}
                            <span class="badge badge-outline badge-xs md:badge-sm capitalize">{{ bet.status }}</span>
                            {% endif %}

                            <div class="dropdown dropdown-end">
                                <label tabindex="0" class="btn btn-xs btn-ghost btn-circle">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                    </svg>
                                </label>
                                <ul tabindex="0"
                                    class="dropdown-content z-[2] menu p-2 shadow bg-base-100 rounded-box w-40 text-xs text-left">
                                    <li><a
                                            onclick="openSettleModal('{{ bet.id }}', '{{ bet.stake }}', '{{ bet.price }}', '{{ bet.status }}')">Edit
                                            / Settle</a></li>
                                    <li><a class="text-error" onclick="deleteBet('{{ bet.id }}')">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-10 text-gray-400">No bets history found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endmacro %}

    {# Bulk Actions Bar #}
    <div id="bulk-actions-bar"
        class="hidden flex items-center gap-4 p-3 bg-base-200 border-b border-base-300 transition-all rounded-t-xl mx-2">
        <div class="flex items-center gap-2">
            <span id="selected-count" class="badge badge-primary font-bold">0</span>
            <span class="text-sm font-medium opacity-70">bets selected</span>
        </div>
        <div class="flex-grow"></div>
        <div class="flex items-center gap-2">
            <select id="bulk-status" class="select select-sm select-bordered">
                <option value="" disabled selected>Update to status...</option>
                <option value="open">Open</option>
                <option value="won">Won</option>
                <option value="lost">Lost</option>
                <option value="void">Void</option>
            </select>
            <button onclick="applyBulkUpdate()" class="btn btn-sm btn-primary">Apply</button>
            <button onclick="clearSelection()" class="btn btn-sm btn-ghost">Cancel</button>
        </div>
    </div>

    {# Tabs Shell #}
    <div class="card bg-base-100 shadow-xl overflow-hidden min-h-[500px]">
        <div role="tablist" class="tabs tabs-lifted w-full">
            {# Live Tab #}
            <a role="tab" class="tab tab-active font-bold gap-2 whitespace-nowrap h-12" id="tab-live"
                onclick="switchTab('live')">
                Live
                {% if live_bets|length > 0 %}
                <span class="badge badge-xs badge-ghost pt-px">{{ '99+' if live_bets|length > 99 else live_bets|length
                    }}</span>
                {% endif %}
            </a>

            {# Open Tab #}
            <a role="tab" class="tab font-bold gap-2 whitespace-nowrap h-12" id="tab-open" onclick="switchTab('open')">
                Open
                {% if open_bets|length > 0 %}
                <span class="badge badge-xs badge-ghost pt-px">{{ '99+' if open_bets|length > 99 else open_bets|length
                    }}</span>
                {% endif %}
            </a>

            {# Unsettled Tab #}
            <a role="tab" class="tab font-bold gap-2 whitespace-nowrap h-12" id="tab-unsettled"
                onclick="switchTab('unsettled')">
                Unsettled
                {% if unsettled_bets|length > 0 %}
                <span class="badge badge-xs badge-warning pt-px">{{ '99+' if unsettled_bets|length > 99 else
                    unsettled_bets|length }}</span>
                {% endif %}
            </a>

            {# Settled Tab #}
            <a role="tab" class="tab font-bold gap-2 whitespace-nowrap h-12" id="tab-settled"
                onclick="switchTab('settled')">
                Settled
                {% if settled_bets|length > 0 %}
                <span class="badge badge-xs badge-ghost pt-px">{{ '99+' if settled_bets|length > 99 else
                    settled_bets|length }}</span>
                {% endif %}
            </a>

            <div class="tab-content bg-base-100 border-base-300 rounded-box p-0 w-full hidden" role="tabpanel"
                id="content-live">
                {{ render_bet_table(live_bets, 'table-live') }}
            </div>
            <div class="tab-content bg-base-100 border-base-300 rounded-box p-0 w-full hidden" role="tabpanel"
                id="content-open">
                {{ render_bet_table(open_bets, 'table-open') }}
            </div>
            <div class="tab-content bg-base-100 border-base-300 rounded-box p-0 w-full hidden" role="tabpanel"
                id="content-unsettled">
                {{ render_bet_table(unsettled_bets, 'table-unsettled') }}
            </div>
            <div class="tab-content bg-base-100 border-base-300 rounded-box p-0 w-full hidden" role="tabpanel"
                id="content-settled">
                {{ render_bet_table(settled_bets, 'table-settled') }}
            </div>
        </div>
    </div>
</div>

<!-- Settle Modal (Unchanged logic) -->
<dialog id="settle-modal" class="modal">
    <div class="modal-box max-w-sm">
        <h3 class="font-bold text-lg mb-4">Settle Bet #<span id="modal-bet-id-display"></span></h3>
        <input type="hidden" id="modal-bet-id">
        <div class="flex flex-col gap-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="form-control w-full">
                    <label class="label"><span
                            class="label-text text-xs opacity-70 uppercase font-bold">Stake</span></label>
                    <input type="number" step="0.01" id="modal-bet-stake"
                        class="input input-bordered w-full font-mono text-sm" oninput="calculateSettlement()" />
                </div>
                <div class="form-control w-full">
                    <label class="label"><span class="label-text text-xs opacity-70 uppercase font-bold">Odds
                            (Price)</span></label>
                    <input type="number" step="0.01" id="modal-bet-price"
                        class="input input-bordered w-full font-mono text-sm" oninput="calculateSettlement()" />
                </div>
            </div>
            <label class="label"><span class="label-text">Outcome</span></label>
            <select id="modal-outcome" class="select select-bordered w-full" onchange="calculateSettlement()">
                <option value="open">Open / Pending</option>
                <option value="won">Won</option>
                <option value="lost">Lost</option>
                <option value="void">Void</option>
            </select>
        </div>
        <div class="form-control w-full">
            <label class="label"><span class="label-text">Payout Amount</span></label>
            <div class="relative flex items-center">
                <input type="number" step="0.01" id="modal-payout" class="input input-bordered w-full text-lg font-bold"
                    value="0.00" />
                <span class="absolute right-4 text-sm opacity-50">EUR</span>
            </div>
        </div>
        <div class="divider my-1"></div>
        <div class="grid grid-cols-1 gap-1 text-xs opacity-70">
            <div class="flex justify-between">
                <span>Potential Payout:</span>
                <span id="display-potential" class="font-bold text-accent"></span>
            </div>
        </div>
        <div class="flex gap-2 mt-4">
            <button class="btn btn-ghost flex-1"
                onclick="document.getElementById('settle-modal').close()">Cancel</button>
            <button class="btn btn-primary flex-1" onclick="submitSettlement()">Save</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script>
    function switchTab(tabName) {
        // Update active tab styling
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
        document.getElementById(`tab-${tabName}`).classList.add('tab-active');

        // Show/Hide Content
        ['live', 'open', 'unsettled', 'settled'].forEach(t => {
            const content = document.getElementById(`content-${t}`);
            if (t === tabName) {
                content.classList.remove('hidden');
                content.style.display = 'block';
            } else {
                content.classList.add('hidden');
                content.style.display = 'none';
            }
        });

        localStorage.setItem('my_bets_active_tab', tabName);
        clearSelection();
    }

    function toggleSelectAll(masterCb) {
        const table = masterCb.closest('table');
        const cbs = table.querySelectorAll('.bet-checkbox');
        cbs.forEach(cb => cb.checked = masterCb.checked);
        updateSelectionUI();
    }

    function updateSelectionUI() {
        const selected = document.querySelectorAll('.bet-checkbox:checked');
        const count = selected.length;
        const bar = document.getElementById('bulk-actions-bar');
        const countBadge = document.getElementById('selected-count');

        if (count > 0) {
            bar.classList.remove('hidden');
            countBadge.textContent = count;
        } else {
            bar.classList.add('hidden');
            document.querySelectorAll('.select-all-bets').forEach(cb => cb.checked = false);
        }
    }

    function clearSelection() {
        document.querySelectorAll('.bet-checkbox, .select-all-bets').forEach(cb => cb.checked = false);
        updateSelectionUI();
    }

    async function applyBulkUpdate() {
        const status = document.getElementById('bulk-status').value;
        if (!status) {
            showToast('Please select a status', 'error');
            return;
        }

        const selectedIds = Array.from(document.querySelectorAll('.bet-checkbox:checked')).map(cb => {
            return cb.closest('tr').dataset.betId;
        });

        if (selectedIds.length === 0) return;
        if (!confirm(`Are you sure you want to update ${selectedIds.length} bets to "${status}"?`)) return;

        try {
            const response = await fetch('/api/v1/bets/bulk', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bet_ids: selectedIds.map(id => parseInt(id)),
                    status: status
                })
            });

            if (response.ok) {
                showToast(`Successfully updated ${selectedIds.length} bets`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const err = await response.json();
                showToast(`Error: ${err.detail || 'Failed to update bets'}`, 'error');
            }
        } catch (e) {
            showToast('Error performing bulk update', 'error');
        }
    }

    function openSettleModal(betId, stake, price, currentStatus) {
        document.getElementById('modal-bet-id').value = betId;
        document.getElementById('modal-bet-id-display').textContent = betId;
        document.getElementById('modal-bet-stake').value = parseFloat(stake).toFixed(2);
        document.getElementById('modal-bet-price').value = parseFloat(price).toFixed(2);
        const outcomeSelect = document.getElementById('modal-outcome');
        if (['won', 'lost', 'void', 'open', 'pending'].includes(currentStatus)) {
            if (currentStatus === 'manual' || currentStatus === 'pending') outcomeSelect.value = 'open';
            else outcomeSelect.value = currentStatus;
        } else outcomeSelect.value = 'open';
        calculateSettlement();
        document.getElementById('settle-modal').showModal();
    }

    function calculateSettlement() {
        const outcome = document.getElementById('modal-outcome').value;
        const stake = parseFloat(document.getElementById('modal-bet-stake').value) || 0;
        const price = parseFloat(document.getElementById('modal-bet-price').value) || 0;
        const potential = stake * price;
        document.getElementById('display-potential').textContent = potential.toFixed(2);
        if (outcome === 'won') document.getElementById('modal-payout').value = potential.toFixed(2);
        else if (outcome === 'void') document.getElementById('modal-payout').value = stake.toFixed(2);
        else if (outcome === 'lost') document.getElementById('modal-payout').value = "0.00";
        else document.getElementById('modal-payout').value = potential.toFixed(2);
    }

    async function submitSettlement() {
        const betId = document.getElementById('modal-bet-id').value;
        const outcome = document.getElementById('modal-outcome').value;
        const payout = parseFloat(document.getElementById('modal-payout').value);
        const stake = parseFloat(document.getElementById('modal-bet-stake').value);
        const price = parseFloat(document.getElementById('modal-bet-price').value);

        const payload = {
            status: outcome,
            payout: payout,
            stake: stake,
            price: price,
            settled_at: outcome !== 'open' ? new Date().toISOString() : null
        };

        try {
            const response = await fetch(`/api/v1/bets/${betId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (response.ok) {
                showToast('Bet updated successfully', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                const err = await response.json();
                showToast(`Error: ${err.detail || 'Failed to update'}`, 'error');
            }
        } catch (e) {
            showToast('Error updating bet', 'error');
        }
    }

    async function deleteBet(betId) {
        if (!confirm('Are you sure you want to delete this bet?')) return;
        try {
            const response = await fetch(`/api/v1/bets/${betId}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('Bet deleted', 'success');
                setTimeout(() => location.reload(), 500);
            } else showToast('Failed to delete bet', 'error');
        } catch (e) { showToast('Error deleting bet', 'error'); }
    }

    function updateTimers() {
        const now = new Date();
        document.querySelectorAll('.event-timer').forEach(el => {
            const startStr = el.dataset.startTime;
            if (!startStr || startStr === 'None') return;
            const startTime = new Date(startStr);
            const diffMs = startTime - now;
            const diffHours = diffMs / (1000 * 60 * 60);
            const status = el.dataset.betStatus;
            const isSettled = ['won', 'lost', 'void', 'settled'].includes(status);
            if (isSettled) {
                el.innerHTML = `<span class="badge badge-ghost badge-xs opacity-50">Completed</span>`;
                return;
            }
            if (diffMs > 0) {
                let label = diffHours < 1 ? `in ${Math.ceil(diffMs / 60000)}m` : (diffHours < 24 ? `in ${Math.round(diffHours)}h` : `in ${Math.round(diffHours / 24)}d`);
                el.innerHTML = `<span class="opacity-70">${label}</span>`;
            } else {
                const hoursSinceStart = -diffHours;
                if (hoursSinceStart < 1.5) el.innerHTML = `<span class="badge badge-warning badge-xs animate-pulse">LIVE</span>`;
                else el.innerHTML = `<span class="badge badge-ghost badge-xs opacity-50">Completed</span>`;
            }
        });
    }

    function renderLocalTimes() {
        document.querySelectorAll('.local-time').forEach(el => {
            const utc = el.dataset.utcTime;
            el.innerHTML = window.formatLocalTime(utc, el.dataset.timeOnly === 'true' ? { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' } : {});
        });
    }

    // Tab persistence logic
    // We already have `switchTab` handling this via onclick.
    // We just need to restore it on load.

    setInterval(updateTimers, 60000);
    document.addEventListener('DOMContentLoaded', () => {
        const activeTab = localStorage.getItem('my_bets_active_tab') || 'live';
        switchTab(activeTab);

        updateTimers();
        renderLocalTimes();
    });
</script>
{% endblock %}