{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="{{ url_for('static', path='js/bet_modal.js') }}"></script>

<style>
    /* Flash animations for odds changes */
    @keyframes flashGreen {
        0% {
            background-color: rgba(34, 197, 94, 0.4);
        }

        100% {
            background-color: transparent;
        }
    }

    @keyframes flashRed {
        0% {
            background-color: rgba(239, 68, 68, 0.4);
        }

        100% {
            background-color: transparent;
        }
    }

    .flash-increase {
        animation: flashGreen 1.5s ease-out;
    }

    .flash-decrease {
        animation: flashRed 1.5s ease-out;
    }

    .pulse-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-connected {
        background-color: #22c55e;
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        animation: pulse-green 2s infinite;
    }

    .status-disconnected {
        background-color: #ef4444;
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }

    @keyframes pulse-green {
        0% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }

        70% {
            transform: scale(1);
            box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }

        100% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
    }
</style>

<div class="w-full px-4 md:px-6 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl md:text-3xl font-bold">Dashboard</h2>
    </div>

    <!-- Widgets Grid: 2 columns on desktop, 1 on mobile -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

        <!-- Widget 1: My Bet Stats -->
        <div class="widget-container h-full">
            <div class="card bg-base-100 shadow-xl h-full">
                <div class="card-body p-4 flex flex-col">
                    <h3 class="card-title text-lg mb-3">My Bet Stats</h3>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="stat p-2 bg-base-200 rounded-lg">
                            <div class="stat-title text-xs">Bankroll</div>
                            <div class="stat-value text-lg md:text-xl" id="widget-bankroll">0.00</div>
                        </div>
                        <div class="stat p-2 bg-base-200 rounded-lg">
                            <div class="stat-title text-xs">Net Profit</div>
                            <div class="stat-value text-lg md:text-xl" id="widget-net-profit">0.00</div>
                        </div>
                        <div class="stat p-2 bg-base-200 rounded-lg">
                            <div class="stat-title text-xs">ROI</div>
                            <div class="stat-value text-lg md:text-xl" id="widget-roi">0.0%</div>
                        </div>
                        <div class="stat p-2 bg-base-200 rounded-lg">
                            <div class="stat-title text-xs">Win Rate</div>
                            <div class="stat-value text-lg md:text-xl" id="widget-win-rate">0.0%</div>
                        </div>
                        <div class="stat p-2 bg-base-200 rounded-lg col-span-2">
                            <div class="stat-title text-xs">Total Bets</div>
                            <div class="stat-value text-lg md:text-xl" id="widget-total-bets">0</div>
                        </div>
                    </div>

                    <div class="w-full h-[150px]">
                        <canvas id="widgetBankrollChart"></canvas>
                    </div>

                    <div class="card-actions justify-end mt-auto">
                        <a href="/analytics" class="btn btn-sm btn-ghost">View Analytics →</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget 2: Next 5 Upcoming Fixtures -->
        <div class="widget-container h-full">
            <div class="card bg-base-100 shadow-xl h-full">
                <div class="card-body p-4 flex flex-col">
                    <h3 class="card-title text-lg mb-3">Upcoming Fixtures</h3>

                    <div id="fixtures-list" class="space-y-2 max-h-[380px] flex-grow overflow-y-auto">
                        <div class="flex justify-center py-4">
                            <span class="loading loading-spinner loading-md"></span>
                        </div>
                    </div>

                    <div class="card-actions justify-end mt-auto">
                        <a href="/fixtures" class="btn btn-sm btn-ghost">View All →</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Width Trade Feed Widget -->
    {% if first_preset %}
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-0">
            <!-- Widget Header with Padding -->
            <div class="p-4 md:p-6 pb-0 md:pb-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <div id="ws-indicator" class="pulse-dot status-disconnected tooltip tooltip-right cursor-help"
                            data-tip="Connecting..."></div>
                        <h3 class="text-xl font-bold">Trade Feed</h3>
                    </div>

                    <!-- Preset Dropdown -->
                    <div class="dropdown">
                        <label tabindex="0" class="btn btn-sm btn-outline">
                            <span id="selected-preset-name">{{ first_preset.name }}</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7">
                                </path>
                            </svg>
                        </label>
                        <ul tabindex="0"
                            class="dropdown-content z-[10] menu p-2 shadow bg-base-100 rounded-box w-52 max-h-60 overflow-y-auto">
                            {% for preset in presets %}
                            {% set p_config = preset.other_config or {} %}
                            <li>
                                <a onclick="changePreset({{ preset.id }}, this.getAttribute('data-name'), '{{ p_config.get('sort_by', 'edge') }}', '{{ p_config.get('sort_order', 'desc') }}', {{ preset.default_stake or 10 }}, '{{ preset.after_trade_action or 'none' }}')"
                                    data-name="{{ preset.name | escape }}">{{ preset.name }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Trade Feed Table (Full Width) -->
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto border-y border-base-300">
                <table class="table table-sm w-full" id="trade-table">
                    <thead class="sticky top-0 bg-base-200 z-10">
                        <tr class="text-xs">
                            <th class="px-2 md:px-4">Time</th>
                            <th class="px-2 md:px-4">Market</th>
                            <th class="px-2 text-center">Odds</th>
                            <th class="px-2 text-center">Prob</th>
                            <th class="px-2 text-center">Edge</th>
                            <th class="px-2 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="trade-feed-body">
                        <tr>
                            <td colspan="6" class="text-center py-10">
                                <span class="loading loading-spinner loading-lg"></span>
                                <div class="mt-2 text-gray-500">Waiting for data...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Widget Footer with Padding -->
            <div class="p-4 md:p-6 pt-2 md:pt-2 text-right">
                <a href="/trade-feed?preset_id={{ first_preset.id }}" class="link text-xs opacity-70">View Full Trade
                    Feed →</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Config for JS -->
<script id="dashboard-config" type="application/json">
    {
        "currentPresetId": {% if first_preset %}{{ first_preset.id }}{% else %}null{% endif %},
        "currentDefaultStake": {% if first_preset %}{{ first_preset.default_stake or 10 }}{% else %}10{% endif %},
        "currentPresetAfterTradeAction": {% if first_preset %}"{{ first_preset.after_trade_action or 'none' }}"{% else %}"none"{% endif %},
        "initialConfig": {% if first_preset %}{{ (first_preset.other_config or {}) | tojson | safe }}{% else %}{}{% endif %}
    }
</script>

<!-- External Dashboard Logic -->
<script src="{{ url_for('static', path='js/dashboard.js') }}"></script>

<!-- Betting Modal -->
{% include 'components/bet_modal.html' %}

{% endblock %}